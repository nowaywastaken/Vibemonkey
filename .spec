## ğŸ“‹ æ¦‚è§ˆ

**Vibemonkey** æ˜¯ä¸€æ¬¾åˆ›æ–°çš„ **Chrome æ‰©å±•ç¨‹åº**ã€‚å®ƒå°† Tampermonkey è„šæœ¬è¿è¡Œå™¨çš„å¼ºå¤§èƒ½åŠ›ä¸ AI çš„ä»£ç ç”Ÿæˆæ™ºæ…§ç›¸ç»“åˆï¼Œåˆ›é€ äº†ä¸€ä¸ªå…¨æ–°çš„å·¥å…·èŒƒå¼ï¼š**Tampermonkey è„šæœ¬è¿è¡Œå™¨ + AI ç”Ÿæˆçš„è„šæœ¬**ã€‚å…¶æ ¸å¿ƒæ˜¯éƒ¨ç½²ä¸€ä¸ª AI Agentï¼Œä½¿å…¶åƒä¸€ä½ä¸“ä¸šçš„è„šæœ¬å·¥ç¨‹å¸ˆï¼Œç†è§£ç”¨æˆ·çš„ç½‘é¡µå®šåˆ¶éœ€æ±‚ï¼Œå¹¶è‡ªåŠ¨å®Œæˆä»ä»£ç ç ”ç©¶ã€è„šæœ¬ç¼–å†™åˆ°æµ‹è¯•è¿è¡Œçš„å…¨è¿‡ç¨‹ã€‚

### ğŸ¯ æ ¸å¿ƒç†å¿µ

Vibemonkey çš„æ„å»ºéµå¾ªä¸¤ä¸ªé¦–è¦åŸåˆ™ï¼š

1. **ç”¨æˆ·ç¾¤ä½“ç»å¯¹åŒ–**ï¼šç›®æ ‡æ˜¯è®©å®Œå…¨ä¸æ‡‚ç¼–ç¨‹çš„ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾è·å¾—ä¸“å±ç½‘é¡µè„šæœ¬ã€‚å› æ­¤ï¼Œ**ç»ä¸èƒ½å‡è®¾ç”¨æˆ·æœ‰ä»»ä½•æŠ€æœ¯èƒ½åŠ›æ¥è§£å†³é—®é¢˜**ã€‚æ‰€æœ‰å¤æ‚æ€§éƒ½åº”ç”± AI Agent æ‰¿æ‹…ã€‚
2. **AI Agent æ‹¥æœ‰æœ€é«˜æƒé™**ï¼šåœ¨è®¾è®¡ç³»ç»Ÿçš„æ‰€æœ‰ Function ä¸å·¥ä½œæµæ—¶ï¼Œæ ¸å¿ƒè€ƒé‡æ˜¯ä¸º Agent æä¾›**å…¨é¢ã€æ— æ­»è§’çš„æ§åˆ¶æƒ**ï¼Œä½¿å…¶èƒ½å¤Ÿåƒäººç±»å¼€å‘è€…ä¸€æ ·ï¼Œè‡ªç”±åœ°æ¢ç´¢ã€å†³ç­–ã€æ‰§è¡Œå’Œä¿®å¤ã€‚

---

## âš™ï¸ æŠ€æœ¯æ¶æ„è¯¦è§£

### 1. åŸºç¡€æŠ€æœ¯æ ˆ

- **AI å¼•æ“**ï¼šåŸºäº DeepSeek V3.2 æ¨¡å‹ï¼Œé€šè¿‡ OpenRouter æ¥å£è°ƒç”¨ã€‚
- **å¼€å‘æ¡†æ¶**ï¼šé‡‡ç”¨ **WXT (Web Extension Toolkit)** æ„å»ºã€‚
    - *è¡¥å……*ï¼šWXT ä¹‹äºæµè§ˆå™¨æ‰©å±•ï¼ŒçŠ¹å¦‚ Next.js ä¹‹äº React åº”ç”¨ã€‚å®ƒå¼•å…¥äº†æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ã€è‡ªåŠ¨å¯¼å…¥ï¼ˆAuto-importsï¼‰å’Œå¤šæµè§ˆå™¨æ„å»ºæ”¯æŒï¼Œæå¤§åœ°é™ä½äº†å¿ƒæ™ºè´Ÿæ‹…ã€‚
- **è„šæœ¬è¯­è¨€**ï¼šä½¿ç”¨ TypeScript ç¼–å†™æ²¹çŒ´è„šæœ¬ï¼Œç¼–è¯‘ä¸çº é”™è¿‡ç¨‹å¯¹ç”¨æˆ·å®Œå…¨é€æ˜ã€‚

### 2. æ™ºèƒ½åŒ–è®°å¿†ç³»ç»Ÿ (Mem0)

ä¸ºé˜²æ­¢â€œä¿®äº†ä¸œå¢™ï¼Œåäº†è¥¿å¢™â€çš„è„šæœ¬é€€åŒ–é—®é¢˜ï¼ŒAgent éœ€è¦ä¸€ä¸ªèƒ½è”ç³»å†å²ã€ç†è§£æ¼”å˜çš„èƒ½åŠ›ã€‚æˆ‘ä»¬ç›´æ¥é›†æˆ **Mem0 è®°å¿†ç³»ç»Ÿ**ï¼Œé€šè¿‡â€œæå–ä¸æ›´æ–°â€çš„æœºåˆ¶æ¥ç®¡ç† AI çš„é•¿æœŸè®°å¿†ã€‚

- **ä¸‰å¤§è®°å¿†ç±»å‹**ï¼š
    1. **ç”¨æˆ·åå¥½è®°å¿†**ï¼šå­˜å‚¨ç”¨æˆ·å¯¹ UIã€äº¤äº’ç­‰ä¸ªæ€§åŒ–è®¾å®šã€‚
    2. **ç½‘ç«™çŸ¥è¯†è®°å¿†**ï¼šå­˜å‚¨é’ˆå¯¹ç‰¹å®šåŸŸåï¼ˆå¦‚ [`example.com`](http://example.com)ï¼‰çš„ç ”ç©¶æˆæœï¼ˆä¾‹å¦‚ï¼Œå…¶è´­ç‰©è½¦æŒ‰é’®æ˜¯é€šè¿‡ XHR å¼‚æ­¥åŠ è½½çš„ï¼‰ã€‚
    3. **è„šæœ¬æ¼”è¿›ç‰ˆæœ¬è®°å¿†**ï¼šå­˜å‚¨æ¯ä¸ªè„šæœ¬çš„å†å²ç‰ˆæœ¬ã€ä¿®æ”¹å†…å®¹å’Œåé¦ˆç»“æœã€‚è¿™æ˜¯è¿½è¸ªâ€œä»£ç å¼‚å‘³â€ã€å®šä½å›å½’é—®é¢˜çš„æ ¸å¿ƒæ•°æ®åº“ã€‚
- **å­˜å‚¨ä¸åŒæ­¥**ï¼š
    - **å­˜å‚¨ä½ç½®**ï¼šäº‘ç«¯å­˜å‚¨ï¼ŒæŒ‰ä¸»åŸŸåè¿›è¡Œé€»è¾‘åˆ†åŒºã€‚
    - **åŒæ­¥ç­–ç•¥**ï¼š**åå°è‡ªåŠ¨åŒæ­¥**ã€‚Agent çš„è®°å¿†ä¼šä¸»åŠ¨åŒæ­¥åˆ°äº‘ç«¯ Mem0ã€‚Memory Function ä¸»è¦ç”¨äºè®© AI **ä¸»åŠ¨è®°å½•**å…³é”®æ´å¯Ÿã€‚

### 3. å®‰å…¨ä¸æ²™ç®±æœºåˆ¶ (QuickJS)

åœ¨â€œæ°›å›´ç¼–ç¨‹â€ä¸­ï¼Œç›´æ¥åœ¨ç”¨æˆ·å½“å‰çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ AI ç”Ÿæˆçš„ JavaScript ä»£ç å…·æœ‰æé«˜çš„é£é™©ã€‚æˆ‘ä»¬å¼•å…¥ **QuickJS-emscripten** (WASM) æ–¹æ¡ˆã€‚

- **å·¥ä½œæµ**ï¼š
    1. **ç¯å¢ƒæ¨¡æ‹Ÿ**ï¼šå°†å½“å‰é¡µé¢çš„ pruned DOM ä½œä¸ºä¸€ä¸ªæ¨¡æ‹Ÿå¯¹è±¡æ³¨å…¥åˆ° QuickJS ä¸Šä¸‹æ–‡ä¸­ã€‚
    2. **æ²™ç®±æ‰§è¡Œ**ï¼šç”Ÿæˆçš„è„šæœ¬åœ¨ QuickJS è™šæ‹Ÿæœºä¸­è¿è¡Œã€‚
    3. **å‰¯ä½œç”¨æ•è·**ï¼šè„šæœ¬å°è¯•æ‰§è¡Œçš„æ“ä½œï¼ˆå¦‚ `document.querySelector('.ad').remove()`ï¼‰ä¼šè¢«æ•è·ã€‚
    4. **å¯è§†åŒ–åé¦ˆ**ï¼šåœ¨çœŸå®é¡µé¢ä¸Šé«˜äº®æ ‡è®°è„šæœ¬**è¯•å›¾**æ“ä½œçš„å…ƒç´ ï¼Œå®ç°â€œå½±å­æ‰§è¡Œï¼ˆShadow Executionï¼‰â€ã€‚

---

## âš“ Manifest V3 é€‚é…ä¸ç”Ÿå­˜ç­–ç•¥

Chrome çš„ Manifest V3 (MV3) åè®®ç”¨çŸ­ç”Ÿå‘½å‘¨æœŸçš„ Service Worker å–ä»£äº†ä¼ ç»Ÿé•¿æœŸè¿è¡Œçš„ Background Pagesï¼Œè¿™ç›´æ¥å¨èƒåˆ° AI Agent æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„èƒ½åŠ›ã€‚

### 1. æ ¸å¿ƒç”Ÿå­˜ç­–ç•¥

åŸºäº WXT æ¡†æ¶ï¼Œé‡‡ç”¨ä¸€å¥—ç»„åˆç­–ç•¥ï¼š

1. **ä»»åŠ¡æ‹†åˆ†ä¸çŠ¶æ€è®°å½•**ï¼šå°†å¤æ‚çš„è„šæœ¬ç”Ÿæˆä»»åŠ¡æ‹†åˆ†ä¸ºç‹¬ç«‹ã€å¯æ¢å¤çš„å°æ­¥éª¤ï¼ˆåˆ†æ DOM â†’ ç”Ÿæˆè„šæœ¬ â†’ ç¼–è¯‘ â†’ æµ‹è¯•ï¼‰ã€‚
2. **å®šæœŸå”¤é†’**ï¼šåˆ©ç”¨ WXT çš„ `browser.alarms` APIï¼Œä»¥ â‰¤5 åˆ†é’Ÿçš„é—´éš”å®šæ—¶å”¤é†’ Service Workerã€‚
3. **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ‰€æœ‰å…³é”®çŠ¶æ€é«˜é¢‘ä¿å­˜åˆ° [`browser.storage`](http://browser.storage)ã€‚Agent é‡å¯æ—¶å¯æ— ç¼æ¢å¤â€œè®°å¿†â€ã€‚

### 2. Service Worker ä¿æ´»æœºåˆ¶ (Keep-Alive Pattern) å®ç°

å•çº¯çš„ `setInterval` åœ¨ MV3 Service Worker ä¸­å¹¶ä¸å¯é ã€‚è§£å†³æ–¹æ¡ˆæ˜¯åŸºäº **Alarms API** çš„ä¿æ´»æ¨¡å¼ã€‚

**æŠ€æœ¯å®ç°ä»£ç **ï¼š

```tsx
// entrypoints/background/keepalive.ts
const HEARTBEAT_INTERVAL_SECONDS = 20;
export function startKeepAlive() {
  chrome.alarms.create('vibemonkey-heartbeat', {
    periodInMinutes: HEARTBEAT_INTERVAL_SECONDS / 60
  });
}
chrome.alarms.onAlarm.addListener((alarm) => {
  if (alarm.name === 'vibemonkey-heartbeat') {
    // æ‰§è¡Œä¸€ä¸ªè½»é‡çº§æ“ä½œä»¥é‡ç½®è®¡æ—¶å™¨
    console.log('Vibemonkey: Heartbeat received');
    void chrome.runtime.getPlatformInfo();
  }
});
```

---

## ğŸ“¡ é€šä¿¡æ¶æ„æ–¹æ¡ˆ

### 1. æ ¸å¿ƒé€šä¿¡é“¾è·¯ï¼šåŒå‘é•¿è¿æ¥ (Port-based)

ç”±äº AI Agent çš„ä»»åŠ¡å±äºâ€œé•¿ä»»åŠ¡â€ï¼Œä¼ ç»Ÿçš„ `sendMessage` å®¹æ˜“ä¸­æ–­ã€‚

- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `chrome.runtime.connect` å»ºç«‹æŒä¹…åŒ–ç«¯å£ (Port)ã€‚
- **ä¼˜åŠ¿**ï¼š
    - **æµå¼è¾“å‡º**ï¼šDeepSeek ç”Ÿæˆçš„ Token å¯ä»¥é€šè¿‡ `port.postMessage` å®æ—¶æ¨é€åˆ° UIã€‚
        - *å®ç°ç»†èŠ‚*ï¼šå°† API è°ƒç”¨å§”æ‰˜ç»™ Background Scriptï¼Œåˆ©ç”¨ `port` é•¿è¿æ¥å›ä¼ æµå¼æ•°æ®ï¼Œè§„é¿ CSP é—®é¢˜ã€‚
    - **ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥**ï¼šé€šè¿‡ `onDisconnect` ç›‘å¬æ•è· SW å…³é—­é£é™©ã€‚

### 2. è·¨å±‚çº§â€œè®°å¿†â€å…±äº«ï¼šReactive Storage

- **æ–¹æ¡ˆ**ï¼š[**`chrome.storage](http://chrome.storage).session` + `onChanged` ç›‘å¬**ã€‚
- **åº”ç”¨**ï¼šAgent çš„å·¥ä½œçŠ¶æ€ï¼ˆå¦‚ `æ­£åœ¨æ€è€ƒ`ï¼‰å’Œ DTPP å‰ªæåçš„ä¸´æ—¶ DOM æ•°æ®ã€‚
- **é€»è¾‘**ï¼šService Worker æ›´æ–°çŠ¶æ€ï¼ŒPopup/Content Script è®¢é˜…å˜æ›´ï¼Œå®ç°**çŠ¶æ€å“åº”å¼åŒæ­¥**ã€‚

### 3. DTPP ä¸å®‰å…¨æ²™ç®±é€šä¿¡æ‹“æ‰‘

| **é€šä¿¡æ–¹å‘** | **æŠ€æœ¯å®ç°** | **æ‰¿è½½æ•°æ®å†…å®¹** |
| --- | --- | --- |
| **SW â†” Content Script** | `tabs.sendMessage` | å‘é€ DTPP è¯„åˆ†å‡½æ•°ï¼Œæ¥æ”¶ç²¾ç®€åçš„ DOM ç‰‡æ®µã€‚ |
| **Content Script â†” Web Page** | `window.postMessage` | æ¢æµ‹ç½‘é¡µåŸç”Ÿçš„ç½‘ç»œè¯·æ±‚æ—¥å¿— (Network Logs)ã€‚ |
| **SW â†” Offscreen Document** | `runtime.sendMessage` | **æ ¸å¿ƒå»ºè®®**ï¼šå°† QuickJS æ²™ç®±æ”¾åœ¨ Offscreen ä¸­è¿è¡Œï¼Œé˜²æ­¢ SW è¢« WASM æŒ‚èµ·ã€‚ |

### 4. é€šä¿¡è¡¥ä¸ (MV3)

- **å¿ƒè·³é‡ç½®**ï¼šåœ¨é•¿è¿æ¥é€šä¿¡ï¼ˆPortï¼‰è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡ `postMessage` æ—¶ï¼Œæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ Keep-Alive æ“ä½œï¼Œé‡ç½®ç©ºé—²è®¡æ—¶å™¨ã€‚
- **çŠ¶æ€æ¢å¤**ï¼šé€šä¿¡åŒ…åŒ…å« `taskId`ï¼ŒSW é‡å¯åæ ¹æ® `storage` ä¸­çš„ `taskId` æ¢å¤ä¸Šä¸‹æ–‡ã€‚

### 5. æ¶æ„æœ€ä½³å®è·µ

- **æ¶ˆæ¯ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript `Discriminated Unions`ã€‚

```tsx
type AgentMessage = 
  | { type: 'STREAM_TOKEN'; payload: string }
  | { type: 'STATUS_CHANGE'; payload: 'thinking' | 'writing' }
  | { type: 'DTPP_RESULT'; payload: ElementCandidate[] };
```

- **é¿å…ä¸»çº¿ç¨‹é˜»å¡**ï¼šDTPP å‰ªæåº”åˆ†ç‰‡å¤„ç†æˆ–ç§»è‡³ Offscreenã€‚

---

## ğŸ¤– æ ¸å¿ƒå·¥ä½œæµä¸ç­–ç•¥

### Agent çš„å¿…å¤‡ç´ è´¨

- **è¿­ä»£æ”¹è¿›èƒ½åŠ›**ï¼šè‡ªè¡Œåˆ†ææ—¥å¿—ï¼Œæ‰¾å‡ºåŸå› å¹¶ä¿®æ”¹è„šæœ¬ã€‚
- **ç»“æœå¯¼å‘æ€ç»´**ï¼šä¸è½»è¨€æ”¾å¼ƒã€‚
- **æ•ˆç‡ä¼˜å…ˆåŸåˆ™**ï¼šä»¥æœ€å°‘çš„æ­¥éª¤å®Œæˆä»»åŠ¡ã€‚

### ç­–ç•¥ä¸€ï¼šæ™ºèƒ½è„šæœ¬è·å–ï¼ˆå…ˆæ‰¾ç°æˆçš„ï¼‰

Agent ä¼˜å…ˆä»å…¨çƒå¼€å‘è€…ç¤¾åŒºå¯»æ‰¾ç°æˆè„šæœ¬ã€‚

- **ç¤¾åŒºæ¥å…¥**ï¼š[Userscript.Zone](http://Userscript.Zone)ã€GreasyForkã€OpenUserJSã€GitHub/Gistã€‚
- **æµç¨‹**ï¼šæœç´¢ â†’ ä»£ç å®¡è®¡ â†’ å·®å¼‚åŒ–å®šåˆ¶ â†’ å®‰å…¨æ€§éªŒè¯ â†’ äº¤ä»˜ã€‚

### ç­–ç•¥äºŒï¼šç½‘é¡µä»£ç çš„æ™ºèƒ½åˆ†æ (DTPP)

**DOM-Tree Pruning Programming (DTPP)** åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼š

| **é˜¶æ®µ** | **æ‰§è¡Œæœºåˆ¶** | **æ ¸å¿ƒè¾“å‡º** |
| --- | --- | --- |
| **1. è§„åˆ™è¿‡æ»¤** | ç§»é™¤æ‰€æœ‰éäº¤äº’ã€ä¸å¯è§çš„å†—ä½™å…ƒç´ ã€‚ | ç»“æ„åŒ–ã€å¯Œå«ä¸Šä¸‹æ–‡çš„äº¤äº’å…ƒç´ æ ‘ã€‚ |
| **2. è¯„åˆ†å‡½æ•°ç”Ÿæˆ** | Agent æ ¹æ®éœ€æ±‚ç”Ÿæˆå…³é”®è¯åŠæƒé‡ã€‚ | å¯æ‰§è¡Œçš„è¯­ä¹‰è¯„åˆ†å‡½æ•°ã€‚ |
| **3. å¤–éƒ¨æ‰§è¡Œä¸æ’åº** | åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­æ‰§è¡Œè¯„åˆ†ï¼Œè¿”å› Top Nã€‚ | é«˜åº¦ç²¾ç®€çš„å…³é”® DOM ç‰‡æ®µï¼ˆè¯­ä¹‰åŒ– Markdownï¼‰ã€‚ |

DTPP å°†å®šä½ç›®æ ‡å…ƒç´ çš„å‡†ç¡®ç‡æå‡è‡³ **88.28%**ã€‚

### ç­–ç•¥ä¸‰ï¼šç¨³å¥çš„å¼‚å¸¸å¤„ç†

- **å¾ªç¯çº é”™**ï¼šåŸºäºæ—¥å¿—ã€çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯è¿›è¡Œâ€œæµ‹è¯•-ä¿®æ”¹â€å¾ªç¯ã€‚
- **è„šæœ¬å†²çªé¢„è§**ï¼šä¸»åŠ¨åˆ†ææ–°æ—§è„šæœ¬å†²çªï¼ˆé€‰æ‹©å™¨ã€äº‹ä»¶ï¼‰ï¼Œè¯¢é—®ç”¨æˆ·å†³ç­–ã€‚

---

## ğŸ§© å·¥ç¨‹åŒ–ä¸å¼€å‘é…ç½®

### é¡¹ç›®è„šæ‰‹æ¶

ä½¿ç”¨ WXT å®˜æ–¹ React æ¨¡æ¿ï¼Œç»“åˆ Tailwind CSS å’Œ Shadcn UIã€‚

```bash
npx wxt@latest init vibemonkey --template react
```

**å…³é”®é…ç½® (`wxt.config.ts`)**ï¼šmacOS HMR ä¼˜åŒ–é…ç½®ã€‚

```tsx
import { defineConfig } from 'wxt';
export default defineConfig({
  manifest: {
    name: 'Vibemonkey',
    description: 'AI-driven Tampermonkey script generator',
    permissions: ['offscreen'],
    host_permissions: []
  },
  modules: ['@wxt-dev/module-react'],
  dev: {
    server: {
      hostname: '0.0.0.0'
    }
  }
});
```

---

## ğŸ–¥ï¸ ç”¨æˆ·äº¤äº’ç•Œé¢ (POPUP)

- **çŠ¶æ€æ **ï¼šæ‰©å±•çŠ¶æ€ã€å½“å‰åŸŸåã€**æ¨¡å‹å·¥ä½œçŠ¶æ€**ï¼ˆæµå¼æ˜¾ç¤ºï¼‰ã€Token ç”¨é‡ã€‚
- **è„šæœ¬åˆ—è¡¨**ï¼š
    - **æ¿€æ´»çš„è„šæœ¬**ï¼šæ˜¾ç¤ºå…·ä½“ä½œç”¨ç½‘å€ï¼ˆåŒºåˆ†å­åŸŸï¼‰ã€‚
    - **æœªæ¿€æ´»çš„è„šæœ¬**ã€‚
- **äº¤äº’åŒºåŸŸ**ï¼š
    - **AI æ¶ˆæ¯**ï¼šæµå¼å›å¤ã€‚
    - **ç”¨æˆ·è¾“å…¥æ¡†**ï¼šéœ€æ±‚ã€åé¦ˆã€‚
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè‡ªåŠ¨è·çŸ¥å½“å‰ç½‘å€å’Œå†å²è„šæœ¬ä¿¡æ¯ã€‚

---

## ğŸ› ï¸ AGENT FUNCTION å…¨é›†

### 1. ç½‘é¡µåˆ†æç±»

```tsx
function getDOMTree(options: { maxDepth?: number; includeHidden?: boolean }): Promise<DOMNode[]>
function findElements(query: { keywords: string[]; weights?: Record<string, number>; topN?: number }): Promise<ElementCandidate[]>
function inspectElement(selector: string): Promise<{ html: string; computedStyles: Record<string, string>; boundingRect: DOMRect; eventListeners: string[]; }>
function getNetworkLogs(filter?: { type?: 'xhr' | 'fetch' | 'script' | 'all'; urlPattern?: string }): Promise<NetworkLogEntry[]>
function getConsoleErrors(): Promise<ConsoleError[]>
```

### 2. è„šæœ¬ç®¡ç†ç±»

```tsx
function getScripts(domain?: string): Promise<Script[]> 
function getScriptHistory(scriptId: string, limit?: number): Promise<ScriptVersion[]> 
function createScript(script: { name: string; description: string; matchUrls: string[]; code: string; enabled?: boolean }): Promise<{ scriptId: string; compileResult: CompileResult }>
function updateScript(scriptId: string, updates: { name?: string; description?: string; matchUrls?: string[]; code?: string; enabled?: boolean }): Promise<{ compileResult: CompileResult }>
function deleteScript(scriptId: string): Promise<void>
function toggleScript(scriptId: string, enabled: boolean): Promise<void>
function rollbackScript(scriptId: string, versionId: string): Promise<void>
```

### 3. è„šæœ¬æ‰§è¡Œä¸æµ‹è¯•ç±»

```tsx
function compileScript(code: string): Promise<CompileResult>
function testScript(code: string, timeout?: number): Promise<TestResult>
function executeScript(scriptId: string): Promise<ExecutionResult>
function stopScript(scriptId: string): Promise<void>
```

### 4. ç¤¾åŒºè„šæœ¬ç±»

```tsx
function searchCommunityScripts(query: { keyword: string; source?: 'greasyfork' | 'openuserjs' | 'github' | 'all'; limit?: number }): Promise<CommunityScript[]>
function getCommunityScriptDetail(url: string): Promise<{ code: string; metadata: ScriptMetadata; ratings: number; installCount: number; }>
function importCommunityScript(url: string, autoAdapt?: boolean): Promise<{ scriptId: string }>
```

### 5. è®°å¿†ç³»ç»Ÿç±» (Mem0)

```tsx
function addMemory(memory: { type: 'user_preference' | 'site_knowledge' | 'script_evolution'; domain?: string; scriptId?: string; content: string; metadata?: Record<string, any> }): Promise<{ memoryId: string }>
function searchMemory(query: { text: string; type?: 'user_preference' | 'site_knowledge' | 'script_evolution'; domain?: string; limit?: number }): Promise<Memory[]>
function getScriptEvolution(scriptId: string): Promise<{ oldMemory: Memory; newMemory: Memory; diff: MemoryDiff; }> 
function updateMemory(memoryId: string, content: string): Promise<void>
function deleteMemory(memoryId: string): Promise<void>
```

### 6. ç”¨æˆ·äº¤äº’ç±»

```tsx
function sendMessage(message: string, type?: 'info' | 'warning' | 'error' | 'success'): Promise<void>
function requestConfirmation(question: string, choices?: string[]): Promise<string>
function requestInput(prompt: string, options?: { placeholder?: string; multiline?: boolean }): Promise<string>
function updateStatus(status: 'idle' | 'thinking' | 'writing' | 'testing' | 'tool_calling', detail?: string): Promise<void>
```

### 7. å·¥å…·ä¸ç¯å¢ƒç±»

```tsx
function getCurrentTab(): Promise<{ url: string; domain: string; title: string }>
function getStorage(keys: string[]): Promise<Record<string, any>>
function setStorage(data: Record<string, any>): Promise<void>
function detectConflicts(newScript: { matchUrls: string[]; code: string }): Promise<Conflict[]>
function getTokenUsage(): Promise<{ used: number; limit: number }>
```

---

## ğŸ“ Implementation Plan: AutoFix å¢å¼º

æœ¬æ¬¡æ›´æ–°åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒä¿®å¤ï¼Œæ—¨åœ¨æå‡ Agent çš„è‡ªä¸»çº é”™èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚

### ä¿®å¤æ¦‚è§ˆ

| ä¿®å¤é¡¹ | ç›®æ ‡ |
| --- | --- |
| **æ— é™é‡è¯•å¾ªç¯** | å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œç›´åˆ°ç”¨æˆ·ä¸»åŠ¨åœæ­¢ |
| **API Key æŒä¹…åŒ–** | æ·»åŠ ä¿å­˜åé¦ˆï¼Œæå‡ç”¨æˆ·æ„ŸçŸ¥ |

---

### Feature 1: æ— é™é‡è¯• + Mem0 è®°å¿†

#### æ ¸å¿ƒé€»è¾‘

```tsx
while (!userStopped) {
  // 1. æŸ¥è¯¢ Mem0 è·å–æ­¤å‰å¤±è´¥çš„å°è¯•
  // 2. å°†å¤±è´¥è®°å½•æ³¨å…¥ promptï¼Œå‘Šè¯‰ AI ä¸è¦é‡å¤
  // 3. æ‰§è¡Œç”Ÿæˆ
  // 4. å¦‚æœå¤±è´¥ â†’ è®°å½•åˆ° Mem0 â†’ continue
  // 5. å¦‚æœæˆåŠŸ â†’ break
}
```

#### [MODIFY] background.ts

**1. æ·»åŠ ç”Ÿæˆä¸­æ–­æ ‡å¿—**

```tsx
let generationAborted = false;

// åœ¨ port.onDisconnect ä¸­è®¾ç½®
port.onDisconnect.addListener(() => {
  generationAborted = true;
});
```

**2. ä¿®æ”¹ handleGenerateScriptStream å‡½æ•°**

```tsx
async function handleGenerateScriptStream(payload) {
  generationAborted = false;
  let retryCount = 0;
  
  while (!generationAborted) {
    retryCount++;
    updateAgentStatus('retrying', retryCount > 1 ? `ç¬¬ ${retryCount} æ¬¡å°è¯•...` : 'æ­£åœ¨ç”Ÿæˆ...');
    
    // 1. æŸ¥è¯¢å†å²å¤±è´¥è®°å½•
    let failedApproaches = '';
    if (mem0Client) {
      const failures = await mem0Client.search(`${domain} è„šæœ¬ç”Ÿæˆå¤±è´¥`, { 
        domain, 
        type: 'script_version' 
      });
      if (failures.length > 0) {
        failedApproaches = '\n\nâš ï¸ ä»¥ä¸‹æ–¹æ³•å·²ç»å¤±è´¥è¿‡ï¼Œè¯·é¿å…ï¼š\n' + 
          failures.slice(0, 5).map(f => `- ${f.content}`).join('\n');
      }
    }
    
    // 2. è¿è¡Œ Agent å¾ªç¯ï¼ˆæ³¨å…¥å¤±è´¥è®°å½•åˆ° promptï¼‰
    const agentLoop = deepseekClient.runStreamingAgentLoop([
      { role: 'system', content: systemPrompt + failedApproaches },
      { role: 'user', content: userPrompt }
    ], getAllTools(), executeTool);
    
    // ... æ‰§è¡Œç”Ÿæˆ ...
    
    // 3. æ£€æŸ¥ç»“æœ
    if (!scriptMatch) {
      // è®°å½•å¤±è´¥åˆ° Mem0
      if (mem0Client) {
        await mem0Client.add(
          `å°è¯• #${retryCount} å¤±è´¥ï¼šæœªèƒ½è§£æä»£ç å—`,
          'script_version',
          { domain, error: 'parse_error' }
        );
      }
      broadcastMessage({ type: 'SCRIPT_GENERATION_RETRY', payload: { attempt: retryCount } });
      continue;
    }
    
    if (!compileResult.success) {
      // è®°å½•ç¼–è¯‘é”™è¯¯åˆ° Mem0
      if (mem0Client) {
        await mem0Client.add(
          `å°è¯• #${retryCount} ç¼–è¯‘å¤±è´¥ï¼š${compileResult.error}\nä»£ç ç‰‡æ®µï¼š${scriptCode.slice(0, 200)}...`,
          'script_version',
          { domain, error: 'compile_error' }
        );
      }
      broadcastMessage({ type: 'SCRIPT_GENERATION_RETRY', payload: { attempt: retryCount, error: compileResult.error } });
      continue;
    }
    
    // 4. æˆåŠŸ - æ¸…ç†å¤±è´¥è®°å½•ï¼ˆå¯é€‰ï¼‰å¹¶è·³å‡º
    break;
  }
  
  if (generationAborted) {
    updateAgentStatus('idle', 'å·²åœæ­¢ç”Ÿæˆ');
    return;
  }
}
```

**3. æ·»åŠ æ¶ˆæ¯ç±»å‹**

```tsx
type AgentMessage = 
  | { type: 'STREAM_TOKEN'; payload: string }
  | { type: 'STATUS_CHANGE'; payload: 'thinking' | 'writing' }
  | { type: 'DTPP_RESULT'; payload: ElementCandidate[] }
  | { type: 'SCRIPT_GENERATION_RETRY'; payload: { attempt: number; error?: string } }; // æ–°å¢
```

#### [MODIFY] App.tsx

å¤„ç† `SCRIPT_GENERATION_RETRY` æ¶ˆæ¯ï¼Œæ›´æ–° UI æ˜¾ç¤ºé‡è¯•çŠ¶æ€ã€‚

---

### Feature 2: API Key æŒä¹…åŒ–åé¦ˆ

#### [MODIFY] background.ts

æ·»åŠ ä¿å­˜æ—¥å¿—ï¼ˆè¯¦è§å‰ç‰ˆæœ¬ï¼‰ã€‚

#### [MODIFY] App.tsx

æ·»åŠ ä¿å­˜ç»“æœåé¦ˆï¼ˆè¯¦è§å‰ç‰ˆæœ¬ï¼‰ã€‚

---

### Verification éªŒè¯æ­¥éª¤

1. `npm run build`
2. æµ‹è¯•ï¼šè¾“å…¥å¤æ‚éœ€æ±‚ï¼Œè§‚å¯Ÿæ˜¯å¦æŒç»­é‡è¯•ç›´åˆ°æˆåŠŸæˆ–æ‰‹åŠ¨å…³é—­ Popup
3. æ£€æŸ¥ Mem0 å­˜å‚¨ä¸­æ˜¯å¦æœ‰å¤±è´¥è®°å½•

---

## âœ… æ€»ç»“

Vibemonkey é€šè¿‡æ·±åº¦èåˆ AI Agent ä¸æµè§ˆå™¨æ‰©å±•èƒ½åŠ›ï¼Œå°†å¤æ‚çš„ç½‘é¡µè„šæœ¬ç¼–å†™è¿‡ç¨‹è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€‚å®ƒé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¶æ„åº”å¯¹äº† MV3 çš„æŠ€æœ¯æŒ‘æˆ˜ï¼Œé€šè¿‡åˆ›æ–°çš„ DTPP ç­–ç•¥å’Œ Mem0 è®°å¿†ç³»ç»Ÿç¡®ä¿äº†é«˜å‡†ç¡®æ€§ä¸æŒç»­å­¦ä¹ èƒ½åŠ›ï¼Œå¹¶é€šè¿‡å®‰å…¨æ²™ç®±æœºåˆ¶ä¿éšœäº†ç”¨æˆ·çš„ä½¿ç”¨å®‰å…¨ã€‚å…¶æœ€ç»ˆç›®æ ‡æ˜¯è®©ç½‘é¡µå®šåˆ¶åŒ–å˜å¾—åƒæ—¥å¸¸å¯¹è¯ä¸€æ ·ç®€å•ã€‚